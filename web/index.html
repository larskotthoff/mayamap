<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EEN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Maya Map</title>
    <link rel="stylesheet" href="theme/default/style.css" type="text/css"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://184.72.218.91/OpenLayers.js"></script>
    <script type="text/javascript" src="http://184.72.218.91/jquery-1.4.4.min.js"></script>
    <script type="text/javascript">
        <!--
        var searching = false;
        var timeout;
        var map, terrain, maya, modern;

        function init() {
        OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";
            map = new OpenLayers.Map(('map'), {
                controls: [
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                    new OpenLayers.Control.LayerSwitcher({'ascending':false}),
                    new OpenLayers.Control.Permalink(),
                    new OpenLayers.Control.ScaleLine(),
                    //new OpenLayers.Control.MousePosition(),
                    new OpenLayers.Control.KeyboardDefaults(),
                    new OpenLayers.Control.OverviewMap()
                ],
                projection: "+init=epsg:3857",
                //projection: "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs",
                maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887]
            });
            terrain = new OpenLayers.Layer.XYZ("Terrain",
                    "http://184.72.218.91/tc/terrain/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        maxResolution: 305.7481130859375,
                        units: "m",
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            maya = new OpenLayers.Layer.XYZ("Maya",
                    "http://184.72.218.91/tc/maya/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            maya.setIsBaseLayer(false);
            modern = new OpenLayers.Layer.XYZ("Modern",
                    "http://184.72.218.91/tc/modern/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            modern.setIsBaseLayer(false);
            modern.setVisibility(false);

            gsat = new OpenLayers.Layer.Google("Satellite", {
                    type: google.maps.MapTypeId.SATELLITE
            });
            gsat.MIN_ZOOM_LEVEL = 9;
            gsat.MAX_ZOOM_LEVEL = 16;
            //document.write(gsat.RESOLUTIONS);

            annotations = new OpenLayers.Layer.Text("Annotations", {
                    location: "annotations.txt"
            });
            annotations.setIsBaseLayer(false);
            annotations.setVisibility(false);

            map.addLayers([modern, maya, annotations, terrain, gsat]);
            if(!map.getCenter()) {
                map.setCenter(new OpenLayers.LonLat(-9912410.84903, 2031482.35538), 2);
            }
            map.events.register("changelayer", map, updateLegend)
            map.events.register("zoomend", map, updateLegend)

            var sketchSymbolizers = {
                "Point": {
                    pointRadius: 4,
                    graphicName: "square",
                    fillColor: "white",
                    fillOpacity: 1,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    strokeColor: "#333333"
                },
                "Line": {
                    strokeWidth: 3,
                    strokeOpacity: 1,
                    strokeColor: "#666666",
                    strokeDashstyle: "dash"
                },
                "Polygon": {
                    strokeWidth: 2,
                    strokeOpacity: 1,
                    strokeColor: "#666666",
                    fillColor: "white",
                    fillOpacity: 0.3
                }
            };
            var style = new OpenLayers.Style();
            style.addRules([
                new OpenLayers.Rule({symbolizer: sketchSymbolizers})
            ]);
            var styleMap = new OpenLayers.StyleMap({"default": style});
            
            measureControls = {
                line: new OpenLayers.Control.Measure(
                    OpenLayers.Handler.Path, {
                        persist: true,
                        handlerOptions: {
                            layerOptions: {styleMap: styleMap}
                        }
                    }
                ),
                polygon: new OpenLayers.Control.Measure(
                    OpenLayers.Handler.Polygon, {
                        persist: true,
                        handlerOptions: {
                            layerOptions: {styleMap: styleMap}
                        }
                    }
                )
            };
            
            var control;
            for(var key in measureControls) {
                control = measureControls[key];
                control.events.on({
                    "measure": handleMeasurements,
                    "measurepartial": handleMeasurements
                });
                map.addControl(control);
            }
            
            document.getElementById('noneToggle').checked = true;
            $("#navigation").load("navigation.html");
        }
        
        function handleMeasurements(event) {
            var geometry = event.geometry;
            var units = event.units;
            var order = event.order;
            var measure = event.measure;
            var element = document.getElementById('output');
            var out = "";
            if(order == 1) {
                out += measure.toFixed(3) + " " + units;
            } else {
                out += measure.toFixed(3) + " " + units + "<sup>2</" + "sup>";
            }
            element.innerHTML = out;
        }

        function toggleControl(element) {
            for(key in measureControls) {
                var control = measureControls[key];
                if(element.value == key && element.checked) {
                    control.activate();
                } else {
                    control.deactivate();
                }
            }
        }

        function toggleTools() {
            $("#toolbox").toggleClass("hidden");
            updateMap();
            if($("#toolbox").hasClass("hidden")) {
                $("#showhidetools").html("show legend/tools");
            } else {
                $("#showhidetools").html("hide legend/tools");
                updateLegend();
            }
        }
        
        function toggleNav() {
            $("#nav").toggleClass("hidden");
            updateMap();
            if($("#nav").hasClass("hidden")) {
                $("#showhidenav").html("show navigation");
            } else {
                $("#showhidenav").html("hide navigation");
            }
        }

    function updateMap() {
        $("#map").removeClass();
        $("#footer").removeClass();
        $("#navigation").empty();
        if($("#toolbox").hasClass("hidden") && $("#nav").hasClass("hidden")) {
            $("#map").toggleClass("mapFull");
            $("#footer").toggleClass("footerFull");
        } else if($("#toolbox").hasClass("hidden")) {
            $("#map").toggleClass("mapwNav");
            $("#footer").toggleClass("footerwNav");
            $("#navigation").load("navigation.html");
        } else if($("#nav").hasClass("hidden")) {
            $("#map").toggleClass("mapwTools");
            $("#footer").toggleClass("footerwTools");
        } else {
            $("#map").toggleClass("mapwNavTools");
            $("#footer").toggleClass("footerwNavTools");
            $("#navigation").load("navigation.html");
        }
    }
        
        function updateLegend() {
            $("#legend-maya").empty();
            $("#legend-modern").empty();
            $("#legend-terrain").empty();
            layers = map.getLayersBy("visibility", true);
            for(var i = 0; i < layers.length; i++) {
                if(layers[i].name === "Maya") {
                    if(map.getZoom() >= 5) {
                        $("#legend-maya").load("legend_maya_high.html");
                    } else {
                        $("#legend-maya").load("legend_maya_low.html");
                    }
                } else if(layers[i].name === "Modern") {
                    $("#legend-modern").load("legend_modern.html");
                } else if(layers[i].name === "Terrain") {
                    $("#legend-terrain").load("legend_terrain.html");
                }
            }
        }

    function filter() {
        if(!searching) {
            searching = true;
            timeout = setTimeout(filterInternal, 700);
        } else {
            clearTimeout(timeout);
            timeout = setTimeout(filterInternal, 700);
        }
    }

    function filterInternal() {
        if($("#search").val().length > 2) {
            term = $("#search").val().toLowerCase();

            $("#navigation").find("li").each(function() {
                if($(this).find("a")[0].innerHTML.search(new RegExp(term, "i")) < 0) {
                    $(this).css('display', 'none');
                } else {
                    $(this).css('display', '');
                }
            })
        } else if($("#search").val().length == 0) {
            $("#navigation").find("li").each(function() {
                $(this).css('display', '');
            })
        }
        searching = false;
    }
        // -->
    </script>

    <style type="text/css" rel="stylesheet">
        body {
            background-color: #DCDB76;
            color: #320;
            font-family: sans-serif;
        }
        #map {
            position: fixed;
            border: 1px solid black;
            top: 5px;
            bottom: 2.2em;
        }
        .mapFull { left: 5px; right: 5px; }
        .mapwTools { left: 5px; right: 200px; }
        .mapwNav { left: 190px; right: 5px; }
        .mapwNavTools { left: 190px; right: 200px; }
        #footer {
            position: absolute;
            bottom: 5px;
            padding: 0;
            margin: 0;
            font-size: 0.8em;
            height: 1.5em;
            text-align: center;
        }
        .footerFull { left: 5px; right: 5px; }
        .footerwTools { left: 5px; right: 200px; }
        .footerwNav { left: 190px; right: 5px; }
        .footerwNavTools { left: 190px; right: 200px; }
        #footer > div {
            display: inline-block;
            *display: inline; /* For IE7 */
            width: 33%;
        }
        #output {
            margin: 10px 0 0 0;
            font-weight: bold;
            text-align: center;
        }
        .olImageLoadError {
            background-image: url('http://184.72.218.91/dragon.png');
        }
        .olControlPermalink a {
            font-weight: bold;
            color: #320;
        }
        .olControlScaleLine {
            font-weight: bold;
        }
        /* get rid of google copyright notice */
        .olLayerGoogleCopyright {
            display: none;
        }
        #toolbox {
            position: fixed;
            top: 5px;
            right: 5px;
            width: 190px;
            overflow: auto;
            font-size: 70%;
            height: 100%;
        }
        #nav {
            position: fixed;
            top: 5px;
            left: 5px;
            width: 180px;
            overflow: auto;
            font-size: 70%;
            height: 100%;
        }
        .hidden { display: none; }
        h1 { padding: 0px; margin: 0 0 10px 0; text-align: center; }
        h2 { padding: 0px; margin: 5px 0 5px 0; }
        ul {
            padding-left: 20px;
            margin: 0px;
        }
        li {
            list-style-position: outside;
        }
    </style>

  </head>
  <body onload="init()">
    <div id="map" class="mapwNav"></div>
    <div id="nav">
        <h1>Navigation</h1>
        Search <input type="text" id="search" onkeyup="filter()"></input>
        <ul>
        <div id="navigation"></div>
        </ul>
    </div>
    <div id="toolbox" class="hidden">
        <h1>Legend</h1>
        <div id="legend-terrain"></div>
        <div id="legend-maya"></div>
        <div id="legend-modern"></div>
        <hr/>
        <h1>Tools</h1>
        <input type="radio" name="type" value="none" id="noneToggle"
               onclick="toggleControl(this);" checked="checked" />
        <label for="noneToggle">navigate</label><br/>
        <input type="radio" name="type" value="line" id="lineToggle" onclick="toggleControl(this);" />
        <label for="lineToggle">measure distance</label><br/>
        <input type="radio" name="type" value="polygon" id="polygonToggle" onclick="toggleControl(this);" />
        <label for="polygonToggle">measure area</label><br/>
        <div id="output"></div>
        <hr/>
        <h1>Credits</h1>
        Map by Lars Kotthoff for <a href="http://mayaresearchprogram.org/">Maya Research Program</a>. We are supported by an <a href="http://aws.amazon.com">Amazon Web Services</a> grant.
        <h2>data &copy;</h2>
        <ul>
        <li>NASA/<a href="http://srtm.csi.cgiar.org/">CGIAR-CSI</a> 2004</li>
        <li><a href="http://www.osm.org/">OpenStreetMap</a> 2011</li>
        <li>Belize Tropical Forest Studies 2005</li>
        <li>Guatemala Ministerio de Ambiente y Recursos Naturales 2008</li>
        <li>Walter R. T. Witschey and Clifford T. Brown, <a href="http://mayagis.smv.org/">The Electronic Atlas of Ancient Maya Sites</a> 2010</li>
        <li><a href="http://mayaresearchprogram.org/">Maya Research Program</a> 2010</li>
        </ul>
    </div>
    <!--<object id="northarrow" data="north.svg" type="image/svg+xml"></object>-->
    <div id="footer" class="footerwNav">
        <div align="left"><a href="#" onclick="toggleNav(); return false;" id="showhidenav">hide navigation</a></div>
        <div align="center"><a href="mailto:lars@larsko.org">feedback</a> --
        supported by <a href="http://aws.amazon.com">Amazon Web Services</a></div>
        <div align="right"><a href="#" onclick="toggleTools(); return false;" id="showhidetools">show legend/tools</a></div>
    </div>
  </body>
</html>
