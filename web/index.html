<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EEN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Maya Map</title>
    <link rel="stylesheet" href="theme/default/style.css" type="text/css"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://tiles.mayamap.org/OpenLayers.js"></script>
    <script type="text/javascript" src="http://tiles.mayamap.org/jquery-1.4.4.min.js"></script>
    <script type="text/javascript">
        <!--
        var searching = false;
        var searchTimeout;
        var map, terrain, maya, modern;
        var selectControl;
        var measurePopup;
        var vControls;

        function init() {
            OpenLayers.ImgPath = "http://js.mapbox.com/theme/dark/";
            map = new OpenLayers.Map(('map'), {
                controls: [
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                    new OpenLayers.Control.LayerSwitcher({'ascending':false}),
                    new OpenLayers.Control.Permalink(),
                    new OpenLayers.Control.ScaleLine(),
                    //new OpenLayers.Control.MousePosition(),
                    new OpenLayers.Control.KeyboardDefaults(),
                    new OpenLayers.Control.OverviewMap()
                ],
                projection: "+init=epsg:3857",
                //projection: "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs",
                maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                restrictedExtent: new OpenLayers.Bounds(-10018754.17,1689200.14,-9462156.72,2273030.93),
                resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887]
            });
            terrain = new OpenLayers.Layer.XYZ("Terrain",
                    "http://tiles.mayamap.org/tc/terrain/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        maxResolution: 305.7481130859375,
                        units: "m",
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            maya = new OpenLayers.Layer.XYZ("Maya",
                    "http://tiles.mayamap.org/tc/maya/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            maya.setIsBaseLayer(false);
            modern = new OpenLayers.Layer.XYZ("Modern",
                    "http://tiles.mayamap.org/tc/modern/${z}/${x}/${y}.png", {
                        format: 'image/png',
                        zoomOffset: 9,
                        resolutions: [305.7481130859375,152.87405654296876,76.43702827148438,38.21851413574219,19.109257067871095,9.554628533935547,4.777314266967774,2.388657133483887],
                        sphericalMercator: true
            });
            modern.setIsBaseLayer(false);
            modern.setVisibility(false);

            gsat = new OpenLayers.Layer.Google("Satellite", {
                    type: google.maps.MapTypeId.SATELLITE
            });
            gsat.MIN_ZOOM_LEVEL = 9;
            gsat.MAX_ZOOM_LEVEL = 16;
            //document.write(gsat.RESOLUTIONS);

            annotations = new OpenLayers.Layer.Vector("Annotations", {
                strategies: [new OpenLayers.Strategy.Fixed({preload: true})],
                protocol: new OpenLayers.Protocol.HTTP({
                    url: "annotations.txt",
                    format: new OpenLayers.Format.Text()
                })
            });
            annotations.setIsBaseLayer(false);
            annotations.setVisibility(false);
            selectControl = new OpenLayers.Control.SelectFeature(annotations,
                {onSelect: onFeatureSelect, onUnselect: onFeatureUnselect});
            map.addControl(selectControl);
            selectControl.activate();

            map.addLayers([modern, maya, annotations, terrain, gsat]);
            if(!map.getCenter()) {
                map.setCenter(new OpenLayers.LonLat(-9912410.84903, 2031482.35538), 2);
            }
            map.events.register("changelayer", map, updateLegend)
            map.events.register("zoomend", map, updateLegend)

            sketchSymbolizers = {
                "Point": {
                    pointRadius: 4,
                    graphicName: "square",
                    fillColor: "white",
                    fillOpacity: 1,
                    strokeWidth: 1,
                    strokeOpacity: 1,
                    strokeColor: "#333333"
                },
                "Line": {
                    strokeWidth: 3,
                    strokeOpacity: 1,
                    strokeColor: "#666666",
                    strokeDashstyle: "dash"
                },
                "Polygon": {
                    strokeWidth: 2,
                    strokeOpacity: 1,
                    strokeColor: "#666666",
                    fillColor: "white",
                    fillOpacity: 0.3
                }
            };
            style = new OpenLayers.Style();
            style.addRules([
                new OpenLayers.Rule({symbolizer: sketchSymbolizers})
            ]);
            styleMap = new OpenLayers.StyleMap({"default": style});
            
            linem = new OpenLayers.Control.Measure(
                    OpenLayers.Handler.Path, {
                        displayClass: "measureLength",
                        persist: true,
                        title: "Measure length",
                        handlerOptions: {
                            layerOptions: {styleMap: styleMap}
                        }
                    }
            )
            linem.events.on({
                "measure": handleMeasurements,
                "measurepartial": deleteMeasurePopup,
                "deactivate": deleteMeasurePopup
            });
            aream = new OpenLayers.Control.Measure(
                    OpenLayers.Handler.Polygon, {
                        displayClass: "measureArea",
                        persist: true,
                        title: "Measure area",
                        handlerOptions: {
                            layerOptions: {styleMap: styleMap}
                        }
                    }
            )
            aream.events.on({
                "measure": handleMeasurements,
                "measurepartial": deleteMeasurePopup,
                "deactivate": deleteMeasurePopup
            });

            std = new OpenLayers.Control.MouseDefaults({title:'Move and zoom'});

            panel = new OpenLayers.Control.Panel({defaultControl: std});
            panel.addControls([aream, linem, std]);
            map.addControl(panel);
            
            vControls = $("[id^=OpenLayers.Control.]").not("[id*=ScaleLine]");
            map.events.on({
                "mouseover": showControls,
                "mouseout": hideControls
            });

            $.getJSON('sites.json', function(data) {
              $("#navigation").empty();
              $.each(data, function(id, l) {
                $("#navigation").append('<li><a href="#" onclick="map.setCenter(new OpenLayers.LonLat(' + l[1] + ',' + l[2] + '), 5);">' + l[0] + '</a></li>');
              });
            });
        }

        function hideControls() {
            vControls.hide();
            $("#north").show();
        }

        function showControls() {
            vControls.show();
            $("#north").hide();
        }

        function onPopupClose(evt) {
            selectControl.unselect(this.feature);
        }

        function onFeatureSelect(feature) {
            if(feature.popup) {
                onFeatureUnselect(feature);
                selectControl.unselect(feature);
            } else {
                popup = new OpenLayers.Popup.AnchoredBubble("annotationPopup",
                             feature.geometry.getBounds().getCenterLonLat(),
                             null,
                             "<h2>"+feature.attributes.title + "</h2>" +
                             feature.attributes.description,
                             null, true, onPopupClose);
                popup.maxSize = new OpenLayers.Size(300, 1000);
                popup.autoSize = true;
                popup.keepInMap = true;
                feature.popup = popup;
                popup.feature = feature;
                map.addPopup(popup);
            }
        }

        function onFeatureUnselect(feature) {
            if(feature.popup) {
                popup.feature = null;
                map.removePopup(feature.popup);
                feature.popup.destroy();
                feature.popup = null;
            }
        }

        function deleteMeasurePopup() {
            if(measurePopup) {
                map.removePopup(measurePopup);
                measurePopup.destroy();
                measurePopup = null;
            }
        }
        
        function handleMeasurements(event) {
            geometry = event.geometry;
            units = event.units;
            order = event.order;
            measure = event.measure;
            out = "<strong>";
            if(order == 1) {
                out += measure.toFixed(3) + " " + units;
            } else {
                out += measure.toFixed(3) + " " + units + "<sup>2</" + "sup>";
            }
            out += "</strong>";
            measurePopup = new OpenLayers.Popup.AnchoredBubble("measure",
                         geometry.getBounds().getCenterLonLat(),
                         null, out,
                         null, true, null);
            measurePopup.maxSize = new OpenLayers.Size(300, 1000);
            measurePopup.autoSize = true;
            measurePopup.keepInMap = true;
            map.addPopup(measurePopup);
        }

        function toggleTools() {
            $("#toolbox").toggleClass("hidden");
            updateMap();
            if($("#toolbox").hasClass("hidden")) {
                $("#showhidetools").html("show legend");
            } else {
                $("#showhidetools").html("hide legend");
                updateLegend();
            }
        }
        
        function toggleNav() {
            $("#nav").toggleClass("hidden");
            updateMap();
            if($("#nav").hasClass("hidden")) {
                $("#showhidenav").html("show navigation");
            } else {
                $("#showhidenav").html("hide navigation");
            }
        }

    function updateMap() {
        $("#map").removeClass();
        $("#footer").removeClass();
        if($("#toolbox").hasClass("hidden") && $("#nav").hasClass("hidden")) {
            $("#map").toggleClass("mapFull");
            $("#footer").toggleClass("footerFull");
        } else if($("#toolbox").hasClass("hidden")) {
            $("#map").toggleClass("mapwNav");
            $("#footer").toggleClass("footerwNav");
        } else if($("#nav").hasClass("hidden")) {
            $("#map").toggleClass("mapwTools");
            $("#footer").toggleClass("footerwTools");
        } else {
            $("#map").toggleClass("mapwNavTools");
            $("#footer").toggleClass("footerwNavTools");
        }
    }
        
    function updateLegend() {
        $("#legend-maya").empty();
        $("#legend-modern").empty();
        $("#legend-terrain").empty();
        layers = map.getLayersBy("visibility", true);
        for(i = 0; i < layers.length; i++) {
            if(layers[i].name === "Maya") {
                if(map.getZoom() >= 5) {
                    $("#legend-maya").load("legend_maya_high.html");
                } else {
                    $("#legend-maya").load("legend_maya_low.html");
                }
            } else if(layers[i].name === "Modern") {
                $("#legend-modern").load("legend_modern.html");
            } else if(layers[i].name === "Terrain") {
                $("#legend-terrain").load("legend_terrain.html");
            }
        }
    }

    function filter() {
        if(!searching) {
            searching = true;
            searchTimeout = setTimeout(filterInternal, 700);
        } else {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterInternal, 700);
        }
    }

    function filterInternal() {
        if($("#search").val().length > 2) {
            term = $("#search").val().toLowerCase();

            $("#navigation").find("li").each(function() {
                if($(this).find("a")[0].innerHTML.search(new RegExp(term, "i")) < 0) {
                    $(this).css('display', 'none');
                } else {
                    $(this).css('display', '');
                }
            })
        } else if($("#search").val().length == 0) {
            $("#navigation").find("li").each(function() {
                $(this).css('display', '');
            })
        }
        searching = false;
    }
        // -->
    </script>

    <style type="text/css" rel="stylesheet">
        body {
            background-color: #DCDB76;
            color: #320;
            font-family: sans-serif;
        }
        #map {
            position: fixed;
            border: 1px solid black;
            top: 5px;
            bottom: 2.2em;
        }
        .mapFull { left: 5px; right: 5px; }
        .mapwTools { left: 5px; right: 200px; }
        .mapwNav { left: 190px; right: 5px; }
        .mapwNavTools { left: 190px; right: 200px; }
        #footer {
            position: absolute;
            bottom: 5px;
            padding: 0;
            margin: 0;
            font-size: 0.8em;
            height: 1.5em;
            text-align: center;
        }
        .footerFull { left: 5px; right: 5px; }
        .footerwTools { left: 5px; right: 200px; }
        .footerwNav { left: 190px; right: 5px; }
        .footerwNavTools { left: 190px; right: 200px; }
        #footer > div {
            display: inline-block;
            *display: inline; /* For IE7 */
            width: 33%;
        }
        .olImageLoadError {
            background-image: url('http://tiles.mayamap.org/theme/default/img/dragon.png');
        }
        .olControlPermalink a {
            font-weight: bold;
            color: #320;
        }
        .olControlScaleLine {
            font-weight: bold;
        }
        /* get rid of google copyright notice */
        .olLayerGoogleCopyright {
            display: none;
        }
        .olControlPanel div { 
            position: relative;
            display: block;
            float: right;
            width:  24px;
            height: 22px;
            margin: 5px;
            left: 50px;
        }
        #north {
            position: fixed;
            margin: 5px;
            height: 64px;
            width: 64px;
            z-index: 1000;
            display: none;
        }
        .olControlPanel .olControlMouseDefaultsItemActive { 
            background-image: url("http://tiles.mayamap.org/theme/default/img/pan_on.png");
        }
        .olControlPanel .olControlMouseDefaultsItemInactive { 
            background-image: url("http://tiles.mayamap.org/theme/default/img/pan_off.png");
        }
        .olControlPanel .measureLengthItemActive { 
          background-image: url("http://tiles.mayamap.org/theme/default/img/draw_line_on.png");
        }
        .olControlPanel .measureLengthItemInactive { 
          background-image: url("http://tiles.mayamap.org/theme/default/img/draw_line_off.png");
        }
        .olControlPanel .measureAreaItemActive { 
          background-image: url("http://tiles.mayamap.org/theme/default/img/draw_polygon_on.png");
        }
        .olControlPanel .measureAreaItemInactive { 
          background-image: url("http://tiles.mayamap.org/theme/default/img/draw_polygon_off.png");
        }
        #toolbox {
            position: fixed;
            top: 5px;
            right: 5px;
            width: 190px;
            overflow: auto;
            font-size: 70%;
            height: 100%;
        }
        #nav {
            position: fixed;
            top: 5px;
            left: 5px;
            width: 180px;
            overflow: auto;
            font-size: 70%;
            height: 100%;
        }
        .hidden { display: none; visibility: hidden; }
        h1 { padding: 0px; margin: 0 0 10px 0; text-align: center; }
        h2 { padding: 0px; margin: 5px 0 5px 0; }
        ul {
            padding-left: 20px;
            margin: 0px;
        }
        li {
            list-style-position: outside;
        }
    </style>

  </head>
  <body onload="init()">
    <div id="map" class="mapwNav">
        <img id="north" src="http://tiles.mayamap.org/theme/default/img/north.png"/>
    </div>
    <div id="nav">
        <h1>Navigation</h1>
        Search <input type="text" id="search" onkeyup="filter()"></input>
        <ul>
        <div id="navigation">loading...</div>
        </ul>
    </div>
    <div id="toolbox" class="hidden">
        <h1>Legend</h1>
        <div id="legend-terrain"></div>
        <div id="legend-maya"></div>
        <div id="legend-modern"></div>
        <hr/>
        <h1>Credits</h1>
        Map by Lars Kotthoff for <a href="http://mayaresearchprogram.org/">Maya Research Program</a>. We are supported by an <a href="http://aws.amazon.com">Amazon Web Services</a> grant.
        <h2>data &copy;</h2>
        <ul>
        <li>NASA/<a href="http://srtm.csi.cgiar.org/">CGIAR-CSI</a> 2004</li>
        <li><a href="http://www.osm.org/">OpenStreetMap</a> 2011</li>
        <li>Belize Tropical Forest Studies 2005</li>
        <li>Guatemala Ministerio de Ambiente y Recursos Naturales 2008</li>
        <li>Walter R. T. Witschey and Clifford T. Brown, <a href="http://mayagis.smv.org/">The Electronic Atlas of Ancient Maya Sites</a> 2010</li>
        <li><a href="http://mayaresearchprogram.org/">Maya Research Program</a> 2010</li>
        </ul>
    </div>
    <div id="footer" class="footerwNav">
        <div align="left"><a href="#" onclick="toggleNav(); return false;" id="showhidenav">hide navigation</a></div>
        <div align="center"><a href="mailto:lars@larsko.org">feedback</a> &mdash;
        supported by <a href="http://aws.amazon.com">Amazon Web Services</a></div>
        <div align="right"><a href="#" onclick="toggleTools(); return false;" id="showhidetools">show legend</a></div>
    </div>
  </body>
</html>
